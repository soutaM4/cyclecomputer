<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>オフライン サイクルコンピュータ</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CycleComp">
    <link rel="manifest" href="/manifest.json">
    
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">

    <style>
        /* --- CSS: スタイリング --- */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #2c3e50; /* ダークブルー */
            color: #ecf0f1; /* 明るいグレー */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            text-align: center;
            overflow: hidden; 
        }

        .container {
            background-color: #34495e; 
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 450px;
        }

        h1 {
            color: #f1c40f; 
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        /* 1. 現在速度 (メイン表示) */
        #main-speed-display {
            background-color: #e74c3c; 
            color: white;
            padding: 15px 5px 10px 5px; 
            border-radius: 10px;
            margin-bottom: 25px; 
        }

        #speed-value-large {
            font-size: 5.5em; 
            font-weight: bold;
            line-height: 1.1;
        }

        #speed-value-large .unit {
            font-size: 0.35em; 
            color: white;
            margin-left: 5px;
            vertical-align: top;
        }
        
        #main-speed-display .label {
            font-size: 0.8em;
            color: #f1c40f; 
            display: block;
            margin-bottom: 0px;
        }

        /* 2. その他のデータ表示 (2x2 均等グリッド) */
        .grid-display {
            display: grid;
            grid-template-columns: 1fr 1fr; 
            grid-template-rows: auto auto;
            gap: 15px; 
            margin-bottom: 25px;
        }

        .data-display {
            background-color: #46627f;
            padding: 15px 10px;
            border-radius: 8px;
            text-align: center;
        }

        .label {
            font-size: 0.7em;
            color: #bdc3c7;
            display: block;
            margin-bottom: 3px;
            font-weight: lighter;
            text-transform: uppercase;
        }

        .value {
            font-size: 1.6em;
            font-weight: bold;
            color: #ecf0f1;
            line-height: 1.2;
        }

        .unit {
            font-size: 0.6em;
            color: #f39c12; 
            margin-left: 3px;
        }

        /* ボタンとステータス */
        .button-group {
            display: flex;
            gap: 10px;
            width: 100%;
            margin-bottom: 10px;
        }

        button {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 10px;
            text-transform: uppercase;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            flex-grow: 1; /* グループ内で均等な幅を占める */
        }
        
        #start-button {
            background-color: #2ecc71; /* 緑 */
        }
        #pause-resume-button {
            background-color: #f1c40f; /* 黄色 */
            color: #34495e;
        }
        #stop-reset-button {
            background-color: #e74c3c; /* 赤 */
        }

        button:hover {
            opacity: 0.8;
        }

        #status {
            margin-top: 15px;
            font-style: italic;
            color: #9b59b6;
        }
        
        /* 設定エリアのスタイル */
        .settings {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #46627f;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .settings label {
            font-size: 0.8em;
            color: #bdc3c7;
        }
        .settings select {
            padding: 8px;
            border-radius: 5px;
            background-color: #46627f;
            color: white;
            border: 1px solid #5b7692;
            appearance: none; 
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>サイクルコンピュータ</h1>

        <div id="main-speed-display">
            <span class="label">現在の速度</span>
            <div id="speed-value-large">0.0<span class="unit">km/h</span></div>
        </div>
        
        <div class="grid-display">
            <div class="data-display" id="distance-container">
                <span class="label">走行距離 (DISTANCE)</span>
                <div class="value" id="distance-value">0.00<span class="unit">km</span></div>
            </div>

            <div class="data-display" id="time-container">
                <span class="label">経過タイム (TIME)</span>
                <div class="value" id="time-value">00:00:00</div>
            </div>

            <div class="data-display" id="max-speed-container">
                <span class="label">最高速度 (MAX SPEED)</span>
                <div class="value" id="max-speed-value">0.0<span class="unit">km/h</span></div>
            </div>
            
            <div class="data-display" id="avg-speed-container">
                <span class="label">平均速度 (AVG SPEED)</span>
                <div class="value" id="avg-speed-value">0.0<span class="unit">km/h</span></div>
            </div>
        </div>
        
        <div class="button-group">
            <button id="start-button">計測開始</button>
        </div>
        <div class="button-group" style="display: none;" id="active-buttons">
            <button id="pause-resume-button">一時停止</button>
            <button id="stop-reset-button">停止・リセット</button>
        </div>

        <div id="status">位置情報サービスを開始してください。</div>
        
        <div class="settings">
            <label for="update-interval">GPS更新間隔設定 (ms):</label>
            <select id="update-interval">
                <option value="100" selected>100 ms (超高頻度)</option>
                <option value="500">500 ms (高頻度)</option>
                <option value="1000">1000 ms (標準)</option>
                <option value="2000">2000 ms (省電力)</option>
                <option value="5000">5000 ms (低頻度)</option>
            </select>
        </div>
        </div>

    <script>
        // Service Worker の登録 (変更なし)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // sw.jsを登録
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => {
                        console.log('Service Worker registered! Scope:', reg.scope);
                    })
                    .catch(err => {
                        console.log('Service Worker registration failed:', err);
                    });
            });
        }
    </script>
    
    <script>
        /* --- JavaScript: 処理ロジック (一時停止機能を追加) --- */

        // DOM要素の取得
        const speedValueLarge = document.getElementById('speed-value-large');
        const distanceValue = document.getElementById('distance-value');
        const maxSpeedValue = document.getElementById('max-speed-value');
        const avgSpeedValue = document.getElementById('avg-speed-value');
        const timeValue = document.getElementById('time-value');
        
        // ボタンの取得
        const startButton = document.getElementById('start-button');
        const pauseResumeButton = document.getElementById('pause-resume-button');
        const stopResetButton = document.getElementById('stop-reset-button');
        const activeButtonContainer = document.getElementById('active-buttons'); // 新しいボタンコンテナ

        const statusDiv = document.getElementById('status');
        const updateIntervalSelect = document.getElementById('update-interval');

        // 状態変数 (変更・追加あり)
        let isStarted = false;      // 計測が開始されたかどうか (一度でもスタートしたか)
        let isPaused = false;       // 一時停止中かどうか
        let watchId = null;         // GPS監視ID
        let totalDistanceKm = 0;    // 走行距離
        let lastPosition = null;    // 前回の位置
        let lastTimestamp = null;   // 前回のタイムスタンプ
        let maxSpeedKmh = 0;        // 最高速度
        let speedSamples = 0;       // 平均速度サンプル数
        let speedSumKmh = 0;        // 平均速度合計
        let startTime = null;       // 計測開始時間
        let timerInterval = null;   // タイマーID
        let wakeLock = null;        // Wake Lock オブジェクト

        // 一時停止時間の管理 (NEW)
        let pausedTimeMs = 0;       // 合計一時停止時間 (ms)
        let pauseStart = null;      // 一時停止を開始した時間 (ms)
        
        // 定数
        const R_EARTH = 6371; 
        const SPEED_CONVERSION = 3.6; 

        // --- Wake Lock API (変更なし) ---

        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                if (wakeLock) return; // 既にロックを取得していたら何もしない
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock が解放されました');
                        wakeLock = null;
                    });
                    console.log('Wake Lock が有効になりました');
                } catch (err) {
                    console.error('Wake Lock の要求に失敗:', err);
                }
            } else {
                console.log('Wake Lock API はサポートされていません');
            }
        }

        async function releaseWakeLock() {
            if (wakeLock) {
                await wakeLock.release();
                console.log('Wake Lock が解放されました');
                wakeLock = null;
            }
        }

        // --- 距離と速度の計算ロジック (変更なし) ---

        function calculateDistance(pos1, pos2) {
            // ... (前回のコードから変更なし)
            const lat1 = pos1.latitude;
            const lon1 = pos1.longitude;
            const lat2 = pos2.latitude;
            const lon2 = pos2.longitude;

            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);

            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);

            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R_EARTH * c;
        }

        /** 経過タイムを更新する関数 (一時停止時間を考慮) */
        function updateTime() {
            if (startTime === null) return;
            
            // 現在の経過時間から合計一時停止時間を差し引く
            const currentTime = new Date().getTime();
            let elapsed = currentTime - startTime.getTime();

            if (isPaused && pauseStart) {
                // ポーズ中の場合、現時点までの経過時間から、ポーズ開始から現在までの時間を引く
                const currentPauseDuration = currentTime - pauseStart;
                elapsed = elapsed - (pausedTimeMs + currentPauseDuration);
            } else {
                // ポーズ中でない場合、累積ポーズ時間のみを引く
                elapsed -= pausedTimeMs;
            }

            // elapsedが負になるのを防ぐ
            if (elapsed < 0) elapsed = 0; 
            
            const seconds = Math.floor(elapsed / 1000) % 60;
            const minutes = Math.floor(elapsed / (1000 * 60)) % 60;
            const hours = Math.floor(elapsed / (1000 * 60 * 60));

            const format = (num) => String(num).padStart(2, '0');
            
            timeValue.textContent = `${format(hours)}:${format(minutes)}:${format(seconds)}`;
        }

        function successCallback(position) {
            // 一時停止中はGPSデータ処理をスキップ
            if (isPaused) return; 
            
            const { latitude, longitude, speed } = position.coords;
            const currentTimestamp = position.timestamp; 

            // ... (距離、速度、最高速度、平均速度の計算ロジックは変更なし)
            const currentPosition = { latitude, longitude };
            let segmentDistance = 0;
            let currentSpeedKmh = 0.0;

            if (lastPosition) {
                segmentDistance = calculateDistance(lastPosition, currentPosition);
                
                if (segmentDistance > 0.0001 && segmentDistance < 0.5) { 
                    totalDistanceKm += segmentDistance;
                    distanceValue.innerHTML = `${totalDistanceKm.toFixed(2)}<span class="unit">km</span>`;
                } else {
                    lastPosition = currentPosition;
                    lastTimestamp = currentTimestamp;
                    statusDiv.textContent = '計測中... (ノイズフィルタ) 精度: ' + position.coords.accuracy.toFixed(0) + 'm';
                    return;
                }
            }

            if (speed !== null && speed > 0.01) { 
                currentSpeedKmh = speed * SPEED_CONVERSION;
            } else if (lastPosition && lastTimestamp) {
                const timeDeltaSeconds = (currentTimestamp - lastTimestamp) / 1000;
                
                if (timeDeltaSeconds > 0.05) { 
                    const speedMps = (segmentDistance * 1000) / timeDeltaSeconds; 
                    currentSpeedKmh = speedMps * SPEED_CONVERSION; 
                }
            }
            
            if (currentSpeedKmh > 120) { 
                currentSpeedKmh = 0.0;
            }

            speedValueLarge.innerHTML = `${currentSpeedKmh.toFixed(1)}<span class="unit">km/h</span>`;

            if (currentSpeedKmh > maxSpeedKmh) {
                maxSpeedKmh = currentSpeedKmh;
                maxSpeedValue.innerHTML = `${maxSpeedKmh.toFixed(1)}<span class="unit">km/h</span>`;
            }
            
            if (currentSpeedKmh > 0.5) { 
                speedSumKmh += currentSpeedKmh;
                speedSamples++;
                
                if (speedSamples > 0) {
                    const avgSpeed = speedSumKmh / speedSamples;
                    avgSpeedValue.innerHTML = `${avgSpeed.toFixed(1)}<span class="unit">km/h</span>`;
                }
            }

            lastPosition = currentPosition;
            lastTimestamp = currentTimestamp;
            statusDiv.textContent = '計測中... 精度: ' + position.coords.accuracy.toFixed(0) + 'm';
        }

        function errorCallback(error) {
            console.error('位置情報取得エラー:', error);
            let errorMessage = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = '位置情報の利用が許可されていません。';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = '位置情報が利用できません。';
                    break;
                case error.TIMEOUT:
                    errorMessage = '位置情報の取得がタイムアウトしました。';
                    break;
                default:
                    errorMessage = '不明な位置情報エラーが発生しました。';
                    break;
            }
            statusDiv.textContent = `エラー: ${errorMessage}`;
            // エラーが発生した場合、停止処理を行う
            stopTracking(); 
        }

        /** 計測を開始する */
        function startTracking() {
            if ('geolocation' in navigator) {
                // 初回スタート時の初期化
                if (!isStarted) {
                    // 全てのリセット
                    totalDistanceKm = 0;
                    maxSpeedKmh = 0;
                    speedSamples = 0;
                    speedSumKmh = 0;
                    lastPosition = null;
                    lastTimestamp = null; 
                    startTime = new Date(); // 計測開始時刻を記録
                    pausedTimeMs = 0;
                    
                    initializeDisplay(); // 表示をリセット
                    isStarted = true;
                }
                
                // 画面スリープ防止ロックを要求
                requestWakeLock();
                
                // ユーザーが設定した更新間隔を取得
                const selectedTimeout = parseInt(updateIntervalSelect.value, 10);

                const options = {
                    enableHighAccuracy: true,
                    timeout: selectedTimeout, 
                    maximumAge: 50 
                };

                watchId = navigator.geolocation.watchPosition(
                    successCallback,
                    errorCallback,
                    options
                );

                // タイマーを起動
                timerInterval = setInterval(updateTime, 1000); 

                isPaused = false;
                
                // UI更新
                updateButtonState();
                statusDiv.textContent = '位置情報取得中...';

            } else {
                statusDiv.textContent = 'エラー: このブラウザはGeolocation APIに対応していません。';
            }
        }
        
        /** 計測を一時停止する (NEW) */
        function pauseTracking() {
            if (!isStarted || isPaused) return; // 開始されていない、または既に一時停止中ならスキップ

            // 1. GPSとタイマーを停止
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            if (timerInterval !== null) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // 2. 画面スリープ防止ロックを解放
            releaseWakeLock();

            // 3. 一時停止のタイムスタンプを記録
            pauseStart = new Date().getTime();
            
            // 4. 速度表示を0にリセット
            speedValueLarge.innerHTML = `0.0<span class="unit">km/h</span>`;

            // 5. 状態を更新
            isPaused = true;

            // UI更新
            updateButtonState();
            statusDiv.textContent = '一時停止中... [再開]を押してください。';
        }

        /** 計測を再開する (NEW) */
        function resumeTracking() {
            if (!isStarted || !isPaused) return; // 開始されていない、または一時停止中でないならスキップ

            // 1. ポーズ時間の蓄積
            if (pauseStart !== null) {
                pausedTimeMs += new Date().getTime() - pauseStart;
                pauseStart = null;
            }

            // 2. GPSとタイマーを再開
            startTracking(); 

            // 3. 状態を更新
            isPaused = false;
            
            // UI更新はstartTracking()内で実行される
        }

        /** 計測を完全に停止し、データをリセットする */
        function stopTracking() {
            // GPSとタイマーをクリア (ポーズ状態からでも実行可能)
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            if (timerInterval !== null) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // 画面スリープ防止ロックを解放
            releaseWakeLock();

            // 状態とデータをリセット
            isStarted = false;
            isPaused = false;
            startTime = null;
            lastTimestamp = null; 
            pauseStart = null;
            
            // 最終表示更新
            distanceValue.innerHTML = `${totalDistanceKm.toFixed(2)}<span class="unit">km</span>`;
            maxSpeedValue.innerHTML = `${maxSpeedKmh.toFixed(1)}<span class="unit">km/h</span>`;
            if (speedSamples > 0) {
                const avgSpeed = speedSumKmh / speedSamples;
                avgSpeedValue.innerHTML = `${avgSpeed.toFixed(1)}<span class="unit">km/h</span>`;
            } else {
                avgSpeedValue.innerHTML = `0.0<span class="unit">km/h</span>`;
            }
            
            // 速度とタイム表示をリセット (UIに現在の値を残し、初期表示はリセットしない)
            speedValueLarge.innerHTML = `0.0<span class="unit">km/h</span>`;

            // UI更新
            updateButtonState();
            statusDiv.textContent = `計測終了。総走行距離: ${totalDistanceKm.toFixed(2)}km`;
        }
        
        /** ボタンの表示状態を現在の状態に基づいて更新する (NEW) */
        function updateButtonState() {
            startButton.style.display = 'none';
            activeButtonContainer.style.display = 'none';
            
            if (!isStarted) {
                // 初期状態 / 停止後
                startButton.style.display = 'block';
                startButton.textContent = '計測開始';
            } else {
                // 計測開始済み (実行中 or 一時停止中)
                activeButtonContainer.style.display = 'flex';
                stopResetButton.textContent = '停止・リセット';
                
                if (isPaused) {
                    // 一時停止中
                    pauseResumeButton.textContent = '計測再開';
                    pauseResumeButton.style.backgroundColor = '#2ecc71'; /* 緑 */
                } else {
                    // 実行中
                    pauseResumeButton.textContent = '一時停止';
                    pauseResumeButton.style.backgroundColor = '#f1c40f'; /* 黄色 */
                }
            }
        }

        // イベントリスナーの設定
        startButton.addEventListener('click', startTracking);
        pauseResumeButton.addEventListener('click', () => {
            if (!isPaused) {
                pauseTracking();
            } else {
                resumeTracking();
            }
        });
        stopResetButton.addEventListener('click', stopTracking);


        // 初期表示
        function initializeDisplay() {
            distanceValue.innerHTML = `0.00<span class="unit">km</span>`;
            maxSpeedValue.innerHTML = `0.0<span class="unit">km/h</span>`;
            avgSpeedValue.innerHTML = `0.0<span class="unit">km/h</span>`;
            timeValue.textContent = `00:00:00`;
            speedValueLarge.innerHTML = `0.0<span class="unit">km/h</span>`;
        }
        
        initializeDisplay();
        updateButtonState(); // 初期ボタン状態をセット

        // ページが非表示になったときにWake Lockを再取得するリスナー
        document.addEventListener('visibilitychange', () => {
            // 計測中で、かつ一時停止中でない場合にのみWake Lockを再要求する
            if (wakeLock !== null && document.visibilityState === 'visible' && isStarted && !isPaused) {
                requestWakeLock();
            }
        });
    </script>
</body>
</html>
